# Use the latest 2.1 version of CircleCI pipeline process engine. 
# See: https://circleci.com/docs/2.0/configuration-reference
version: '2.1'
jobs:
  build:
    machine:
      image: ubuntu-1604:202007-01
    steps:
      - checkout
      - run: python --version
      - run: node --version
      - run: >
          pushd octoductor;
          pip3 install ".[test]";
          py.test --cov=. --cov-report term-missing --cov-branch --cov-report=xml -rP;
          popd;
      - run: npm install --legacy-peer-deps
      - run: >
          pushd octoductor/ui;
          npm install;
          CI=false npx react-scripts build;
          popd;
      - run: npx cdk synth > template.yaml
  release:
    docker:
      - image: cimg/base:2021.05
    steps:
      - checkout
      - setup_remote_docker
      - run: docker run hello-world
workflows:
  build:
    when:
      not: << pipeline.git.tag >>
    jobs:
      - build
  release:
    when: << pipeline.git.tag >>
    jobs:
      - release